name: Block Direct Pushes

on:
  push:
    branches:
      - main
      - dev

jobs:
  prevent-direct-push:
    runs-on: [self-hosted, macOS, ARM64]
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check if PR merge or direct push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          forced="$(jq -r '.forced // false' "$GITHUB_EVENT_PATH")"
          if [[ "$forced" == "true" ]]; then
            echo "::error::Force-pushes to protected branches are not allowed."
            exit 1
          fi

          # Allow trusted automation (e.g., auto-sync workflow)
          if [[ "${GITHUB_ACTOR}" == "github-actions[bot]" || "${GITHUB_ACTOR}" == "dependabot[bot]" ]]; then
            echo "Automation push detected ($GITHUB_ACTOR); allowed."
            exit 0
          fi

          # Prefer the GitHub API: allow commits that are part of a merged PR.
          api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls"
          prs_json="$(curl -fsSL \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json, application/vnd.github.groot-preview+json" \
            "$api_url" || true)"

          if [[ -n "$prs_json" ]]; then
            merged_pr_count="$(echo "$prs_json" | jq '[.[] | select(.merged_at != null)] | length')"
            if [[ "${merged_pr_count}" -gt 0 ]]; then
              echo "Merged PR detected for ${GITHUB_SHA}; allowed."
              exit 0
            fi
          fi

          # Fallback: GitHub's commitâ†’PR association can miss merge commits created by the merge API,
          # especially when custom merge commit messages are used. In that case, locate a merged PR whose
          # `merge_commit_sha` matches the pushed SHA.
          pr_search_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?state=closed&sort=updated&direction=desc&per_page=50"
          recent_prs_json="$(curl -fsSL \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$pr_search_url" || true)"

          if [[ -n "$recent_prs_json" ]]; then
            merged_pr_count="$(echo "$recent_prs_json" | jq --arg sha "${GITHUB_SHA}" '[.[] | select(.merge_commit_sha == $sha and .merged_at != null)] | length')"
            if [[ "${merged_pr_count}" -gt 0 ]]; then
              echo "Merged PR detected by merge_commit_sha for ${GITHUB_SHA}; allowed."
              exit 0
            fi
          fi

          message="$(jq -r '.head_commit.message // ""' "$GITHUB_EVENT_PATH")"

          # Allow merge commits (regular merge)
          if [[ "$message" == Merge\ pull\ request* ]]; then
            echo "Regular merge commit detected; allowed."
            exit 0
          fi

          # Allow squash merges (contain PR number like "(#123)" anywhere)
          if [[ "$message" =~ \(#[0-9]+\) ]]; then
            echo "Squash merge detected; allowed."
            exit 0
          fi

          # Allow rebase merges from GitHub (pusher is web-flow)
          pusher="$(jq -r '.pusher.name // ""' "$GITHUB_EVENT_PATH")"
          if [[ "$pusher" == "web-flow" ]]; then
            echo "GitHub web merge detected; allowed."
            exit 0
          fi

          echo "::error::Direct pushes to protected branches are not allowed. Open a pull request instead."
          exit 1
