generator client {
  provider = "prisma-client-js"
  output   = "../../../packages/prisma-plutus/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Brand represents a product line tracked separately for P&L (e.g., "US-Dust Sheets", "UK-Dust Sheets")
model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  marketplace String   // e.g., "amazon.com", "amazon.co.uk"
  currency    String   // e.g., "USD", "GBP"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  skus Sku[]

  @@index([marketplace])
}

/// Sku maps a product SKU to a brand for COGS calculation
model Sku {
  id          String   @id @default(cuid())
  sku         String
  productName String?
  asin        String?
  brandId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([sku, brandId])
  @@index([brandId])
}

/// SetupConfig stores the QBO account mappings and setup state
/// There should only be one row in this table per tenant
model SetupConfig {
  id        String   @id @default(cuid())
  
  // QBO Account Mappings - stores the QBO account ID for each category
  // Inventory Asset accounts
  invManufacturing    String?
  invFreight          String?
  invDuty             String?
  invMfgAccessories   String?
  
  // COGS accounts
  cogsManufacturing   String?
  cogsFreight         String?
  cogsDuty            String?
  cogsMfgAccessories  String?
  cogsLandFreight     String?
  cogsStorage3pl      String?
  cogsShrinkage       String?
  productExpenses     String?

  // Warehousing buckets (COGS)
  warehousing3pl      String?
  warehousingAmazonFc String?
  warehousingAwd      String?
  
  // LMB Revenue/Fee accounts
  amazonSales                      String?
  amazonRefunds                    String?
  amazonFbaInventoryReimbursement  String?
  amazonSellerFees                 String?
  amazonFbaFees                    String?
  amazonStorageFees                String?
  amazonAdvertisingCosts           String?
  amazonPromotions                 String?
  
  // Setup status
  accountsCreated Boolean @default(false)

  // Autopost settings
  autopostEnabled    Boolean  @default(false)
  autopostStartDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// AuditDataUpload tracks a single LMB Audit Data CSV upload.
/// One CSV may contain rows for multiple settlements (Invoice groups).
model AuditDataUpload {
  id        String   @id @default(cuid())
  filename  String
  rowCount  Int
  invoiceCount Int
  uploadedAt DateTime @default(now())

  rows AuditDataRow[]
}

/// AuditDataRow stores a single parsed row from an LMB Audit Data CSV.
/// Rows are grouped by invoiceId which maps to one LMB settlement.
model AuditDataRow {
  id        String   @id @default(cuid())

  invoiceId   String
  market      String
  date        String   // YYYY-MM-DD
  orderId     String
  sku         String
  quantity    Int
  description String
  net         Int      // cents

  uploadId String
  upload   AuditDataUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([uploadId])
  @@index([uploadId, invoiceId])
}

/// SettlementProcessing tracks Plutus processing for a single LMB settlement invoice group.
/// Used for idempotency, history, and settlement list status.
model SettlementProcessing {
  id String @id @default(cuid())

  marketplace              String // e.g., "amazon.com", "amazon.co.uk"
  qboSettlementJournalEntryId String
  lmbDocNumber             String
  lmbPostedDate            DateTime

  invoiceId       String
  processingHash  String
  sourceFilename  String
  uploadedAt      DateTime @default(now())

  qboCogsJournalEntryId      String
  qboPnlReclassJournalEntryId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderSales OrderSale[]
  orderReturns OrderReturn[]

  @@unique([marketplace, invoiceId])
  @@unique([qboSettlementJournalEntryId])
  @@index([marketplace])
  @@index([marketplace, createdAt])
}

/// SettlementRollback tracks manual rollbacks of processed settlements.
/// We keep these rows even though the SettlementProcessing row is deleted so the UI can show
/// "rolled back" status and keep a simple audit trail.
model SettlementRollback {
  id String @id @default(cuid())

  marketplace                String
  qboSettlementJournalEntryId String
  lmbDocNumber               String
  lmbPostedDate              DateTime

  invoiceId      String
  processingHash String
  sourceFilename String
  processedAt    DateTime

  qboCogsJournalEntryId       String
  qboPnlReclassJournalEntryId String

  orderSalesCount   Int
  orderReturnsCount Int

  rolledBackAt DateTime @default(now())

  @@index([qboSettlementJournalEntryId])
  @@index([marketplace])
}

/// OrderSale stores per-order, per-SKU COGS results for refund matching across periods.
model OrderSale {
  id String @id @default(cuid())

  marketplace String
  orderId     String
  sku         String

  saleDate    DateTime
  quantity    Int

  principalCents            Int
  costManufacturingCents    Int
  costFreightCents          Int
  costDutyCents             Int
  costMfgAccessoriesCents   Int

  settlementProcessingId String
  settlementProcessing   SettlementProcessing @relation(fields: [settlementProcessingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, orderId, sku])
  @@index([settlementProcessingId])
  @@index([marketplace])
  @@index([saleDate])
}

/// OrderReturn stores per-order, per-SKU return (refund) COGS reversals for replaying inventory over time.
model OrderReturn {
  id String @id @default(cuid())

  marketplace String
  orderId     String
  sku         String

  returnDate  DateTime
  quantity    Int

  principalCents            Int
  costManufacturingCents    Int
  costFreightCents          Int
  costDutyCents             Int
  costMfgAccessoriesCents   Int

  settlementProcessingId String
  settlementProcessing   SettlementProcessing @relation(fields: [settlementProcessingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, orderId, sku, settlementProcessingId])
  @@index([settlementProcessingId])
  @@index([marketplace, orderId, sku])
  @@index([returnDate])
}

/// AuditLog tracks user actions across the Plutus app for audit trail purposes.
model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  userName   String
  action     String   // e.g., "SETTLEMENT_PROCESSED", "SETTLEMENT_ROLLED_BACK", "CONFIG_UPDATED", "BRAND_CREATED", "SKU_UPDATED", "ACCOUNTS_CREATED"
  entityType String   // e.g., "SettlementProcessing", "SetupConfig", "Brand", "Sku"
  entityId   String?
  details    Json?    // Additional context
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}

/// NotificationPreference stores per-user notification settings for Plutus events.
model NotificationPreference {
  id                 String   @id @default(cuid())
  userId             String   @unique
  onNewSettlement    Boolean  @default(true)
  onSettlementPosted Boolean  @default(true)
  onProcessingError  Boolean  @default(true)
  onMonthlyAnalytics Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

/// BillMapping links a QBO bill to a PO batch and stores enrichment metadata managed in Plutus.
model BillMapping {
  id          String    @id @default(cuid())
  qboBillId   String    @unique
  poNumber    String
  billDate    String
  vendorName  String
  totalAmount Float
  syncedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  lines BillLineMapping[]

  @@index([poNumber])
}

/// BillLineMapping maps a single QBO bill line to a SKU and quantity for inventory event generation.
model BillLineMapping {
  id            String  @id @default(cuid())
  billMappingId String
  qboLineId     String
  component     String  // 'manufacturing' | 'freight' | 'duty' | 'mfgAccessories'
  sku           String?
  quantity      Int?
  amountCents   Int

  billMapping BillMapping @relation(fields: [billMappingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([billMappingId, qboLineId])
}
