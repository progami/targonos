generator client {
  provider = "prisma-client-js"
  output   = "../../../packages/prisma-plutus/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Brand represents a product line tracked separately for P&L (e.g., "US-Dust Sheets", "UK-Dust Sheets")
model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  marketplace String   // e.g., "amazon.com", "amazon.co.uk"
  currency    String   // e.g., "USD", "GBP"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  skus Sku[]

  @@index([marketplace])
}

/// Sku maps a product SKU to a brand for COGS calculation
model Sku {
  id          String   @id @default(cuid())
  sku         String
  productName String?
  asin        String?
  brandId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([sku, brandId])
  @@index([brandId])
}

/// SetupConfig stores the QBO account mappings and setup state
/// There should only be one row in this table per tenant
model SetupConfig {
  id        String   @id @default(cuid())
  
  // QBO Account Mappings - stores the QBO account ID for each category
  // Inventory Asset accounts
  invManufacturing    String?
  invFreight          String?
  invDuty             String?
  invMfgAccessories   String?
  
  // COGS accounts
  cogsManufacturing   String?
  cogsFreight         String?
  cogsDuty            String?
  cogsMfgAccessories  String?
  cogsLandFreight     String?
  cogsStorage3pl      String?
  cogsShrinkage       String?
  
  // LMB Revenue/Fee accounts
  amazonSales                      String?
  amazonRefunds                    String?
  amazonFbaInventoryReimbursement  String?
  amazonSellerFees                 String?
  amazonFbaFees                    String?
  amazonStorageFees                String?
  amazonAdvertisingCosts           String?
  amazonPromotions                 String?
  
  // Setup status
  accountsCreated Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// SettlementProcessing tracks Plutus processing for a single LMB settlement invoice group.
/// Used for idempotency, history, and settlement list status.
model SettlementProcessing {
  id String @id @default(cuid())

  marketplace              String // e.g., "amazon.com", "amazon.co.uk"
  qboSettlementJournalEntryId String
  lmbDocNumber             String
  lmbPostedDate            DateTime

  invoiceId       String
  processingHash  String
  sourceFilename  String
  uploadedAt      DateTime @default(now())

  qboCogsJournalEntryId      String
  qboPnlReclassJournalEntryId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderSales OrderSale[]
  orderReturns OrderReturn[]

  @@unique([marketplace, invoiceId])
  @@unique([qboSettlementJournalEntryId])
  @@index([marketplace])
}

/// SettlementRollback tracks manual rollbacks of processed settlements.
/// We keep these rows even though the SettlementProcessing row is deleted so the UI can show
/// "rolled back" status and keep a simple audit trail.
model SettlementRollback {
  id String @id @default(cuid())

  marketplace                String
  qboSettlementJournalEntryId String
  lmbDocNumber               String
  lmbPostedDate              DateTime

  invoiceId      String
  processingHash String
  sourceFilename String
  processedAt    DateTime

  qboCogsJournalEntryId       String
  qboPnlReclassJournalEntryId String

  orderSalesCount   Int
  orderReturnsCount Int

  rolledBackAt DateTime @default(now())

  @@index([qboSettlementJournalEntryId])
  @@index([marketplace])
}

/// OrderSale stores per-order, per-SKU COGS results for refund matching across periods.
model OrderSale {
  id String @id @default(cuid())

  marketplace String
  orderId     String
  sku         String

  saleDate    DateTime
  quantity    Int

  principalCents            Int
  costManufacturingCents    Int
  costFreightCents          Int
  costDutyCents             Int
  costMfgAccessoriesCents   Int

  settlementProcessingId String
  settlementProcessing   SettlementProcessing @relation(fields: [settlementProcessingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, orderId, sku])
  @@index([settlementProcessingId])
  @@index([marketplace])
}

/// OrderReturn stores per-order, per-SKU return (refund) COGS reversals for replaying inventory over time.
model OrderReturn {
  id String @id @default(cuid())

  marketplace String
  orderId     String
  sku         String

  returnDate  DateTime
  quantity    Int

  principalCents            Int
  costManufacturingCents    Int
  costFreightCents          Int
  costDutyCents             Int
  costMfgAccessoriesCents   Int

  settlementProcessingId String
  settlementProcessing   SettlementProcessing @relation(fields: [settlementProcessingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, orderId, sku, settlementProcessingId])
  @@index([settlementProcessingId])
  @@index([marketplace, orderId, sku])
}
