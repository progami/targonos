generator client {
  provider = "prisma-client-js"
  output   = "../../../packages/prisma-plutus/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Brand represents a product line tracked separately for P&L (e.g., "US-Dust Sheets", "UK-Dust Sheets")
model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  marketplace String   // e.g., "amazon.com", "amazon.co.uk"
  currency    String   // e.g., "USD", "GBP"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  skus         Sku[]
  billMappings BillMapping[]

  @@index([marketplace])
}

/// Sku maps a product SKU to a brand for COGS calculation
model Sku {
  id          String   @id @default(cuid())
  sku         String
  productName String?
  asin        String?
  brandId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([sku, brandId])
  @@index([brandId])
}

/// SetupConfig stores the QBO account mappings and setup state
/// There should only be one row in this table per tenant
model SetupConfig {
  id        String   @id @default(cuid())
  
  // QBO Account Mappings - stores the QBO account ID for each category
  // Inventory Asset accounts
  invManufacturing    String?
  invFreight          String?
  invDuty             String?
  invMfgAccessories   String?
  
  // COGS accounts
  cogsManufacturing   String?
  cogsFreight         String?
  cogsDuty            String?
  cogsMfgAccessories  String?
  cogsLandFreight     String?
  cogsStorage3pl      String?
  cogsShrinkage       String?

  // Warehousing buckets (COGS)
  warehousing3pl      String?
  warehousingAmazonFc String?
  warehousingAwd      String?
  
  // LMB Revenue/Fee accounts
  amazonSales                      String?
  amazonRefunds                    String?
  amazonFbaInventoryReimbursement  String?
  amazonSellerFees                 String?
  amazonFbaFees                    String?
  amazonStorageFees                String?
  amazonAdvertisingCosts           String?
  amazonPromotions                 String?

  // Product Expenses
  productExpenses                  String?

  // Setup status
  accountsCreated Boolean @default(false)

  // Autopost settings
  autopostEnabled    Boolean  @default(false)
  autopostStartDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// AuditDataUpload tracks a single LMB Audit Data CSV upload.
/// One CSV may contain rows for multiple settlements (Invoice groups).
model AuditDataUpload {
  id        String   @id @default(cuid())
  filename  String
  rowCount  Int
  invoiceCount Int
  uploadedAt DateTime @default(now())

  rows AuditDataRow[]
}

/// AuditDataRow stores a single parsed row from an LMB Audit Data CSV.
/// Rows are grouped by invoiceId which maps to one LMB settlement.
model AuditDataRow {
  id        String   @id @default(cuid())

  invoiceId   String
  market      String
  date        String   // YYYY-MM-DD
  orderId     String
  sku         String
  quantity    Int
  description String
  net         Int      // cents

  uploadId String
  upload   AuditDataUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([uploadId])
  @@index([uploadId, invoiceId])
}

/// SettlementProcessing tracks Plutus processing for a single LMB settlement invoice group.
/// Used for idempotency, history, and settlement list status.
model SettlementProcessing {
  id String @id @default(cuid())

  marketplace              String // e.g., "amazon.com", "amazon.co.uk"
  qboSettlementJournalEntryId String
  lmbDocNumber             String
  lmbPostedDate            DateTime

  invoiceId       String
  processingHash  String
  sourceFilename  String
  uploadedAt      DateTime @default(now())

  qboCogsJournalEntryId      String
  qboPnlReclassJournalEntryId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderSales OrderSale[]
  orderReturns OrderReturn[]
  adsAllocation SettlementAdsAllocation?

  @@unique([marketplace, invoiceId])
  @@unique([qboSettlementJournalEntryId])
  @@index([marketplace])
  @@index([marketplace, createdAt])
}

/// SettlementRollback tracks manual rollbacks of processed settlements.
/// We keep these rows even though the SettlementProcessing row is deleted so the UI can show
/// "rolled back" status and keep a simple audit trail.
model SettlementRollback {
  id String @id @default(cuid())

  marketplace                String
  qboSettlementJournalEntryId String
  lmbDocNumber               String
  lmbPostedDate              DateTime

  invoiceId      String
  processingHash String
  sourceFilename String
  processedAt    DateTime

  qboCogsJournalEntryId       String
  qboPnlReclassJournalEntryId String

  orderSalesCount   Int
  orderReturnsCount Int

  rolledBackAt DateTime @default(now())

  @@index([qboSettlementJournalEntryId])
  @@index([marketplace])
}

/// OrderSale stores per-order, per-SKU COGS results for refund matching across periods.
model OrderSale {
  id String @id @default(cuid())

  marketplace String
  orderId     String
  sku         String

  saleDate    DateTime
  quantity    Int

  principalCents            Int
  costManufacturingCents    Int
  costFreightCents          Int
  costDutyCents             Int
  costMfgAccessoriesCents   Int

  settlementProcessingId String
  settlementProcessing   SettlementProcessing @relation(fields: [settlementProcessingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, orderId, sku])
  @@index([settlementProcessingId])
  @@index([marketplace])
  @@index([saleDate])
}

/// OrderReturn stores per-order, per-SKU return (refund) COGS reversals for replaying inventory over time.
model OrderReturn {
  id String @id @default(cuid())

  marketplace String
  orderId     String
  sku         String

  returnDate  DateTime
  quantity    Int

  principalCents            Int
  costManufacturingCents    Int
  costFreightCents          Int
  costDutyCents             Int
  costMfgAccessoriesCents   Int

  settlementProcessingId String
  settlementProcessing   SettlementProcessing @relation(fields: [settlementProcessingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([marketplace, orderId, sku, settlementProcessingId])
  @@index([settlementProcessingId])
  @@index([marketplace, orderId, sku])
  @@index([returnDate])
}

/// AuditLog tracks user actions across the Plutus app for audit trail purposes.
model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  userName   String
  action     String   // e.g., "SETTLEMENT_PROCESSED", "SETTLEMENT_ROLLED_BACK", "CONFIG_UPDATED", "BRAND_CREATED", "SKU_UPDATED", "ACCOUNTS_CREATED"
  entityType String   // e.g., "SettlementProcessing", "SetupConfig", "Brand", "Sku"
  entityId   String?
  details    Json?    // Additional context
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}

/// NotificationPreference stores per-user notification settings for Plutus events.
model NotificationPreference {
  id                 String   @id @default(cuid())
  userId             String   @unique
  onNewSettlement    Boolean  @default(true)
  onSettlementPosted Boolean  @default(true)
  onProcessingError  Boolean  @default(true)
  onMonthlyAnalytics Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

/// BillMapping links a QBO bill to a PO batch and brand for cost allocation.
model BillMapping {
  id          String    @id @default(cuid())
  qboBillId   String    @unique
  poNumber    String
  brandId     String
  billDate    String
  vendorName  String
  totalAmount Float
  syncedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  brand Brand          @relation(fields: [brandId], references: [id])
  lines BillLineMapping[]

  @@index([poNumber])
  @@index([brandId])
}

/// BillLineMapping tracks a QBO bill line's component, SKU assignment, and amount for cost allocation.
model BillLineMapping {
  id            String  @id @default(cuid())
  billMappingId String
  qboLineId     String
  component     String  // 'manufacturing' | 'freight' | 'duty' | 'mfgAccessories'
  amountCents   Int
  sku           String?
  quantity      Int?

  billMapping BillMapping @relation(fields: [billMappingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([billMappingId, qboLineId])
}

/// AdsDataUpload tracks a manual Amazon Ads report upload.
/// The date range is user-declared so we can validate coverage for settlement invoice ranges.
model AdsDataUpload {
  id         String   @id @default(cuid())

  reportType  String // e.g., "SP_ADVERTISED_PRODUCT"
  marketplace String // e.g., "amazon.com", "amazon.co.uk"
  filename    String

  startDate String // YYYY-MM-DD (declared report range)
  endDate   String // YYYY-MM-DD (declared report range)

  rowCount Int
  skuCount Int
  minDate  String // YYYY-MM-DD (min date found in parsed rows)
  maxDate  String // YYYY-MM-DD (max date found in parsed rows)

  uploadedAt DateTime @default(now())

  rows AdsDataRow[]
  settlementAdsAllocations SettlementAdsAllocation[]

  @@index([marketplace])
  @@index([reportType])
  @@index([marketplace, reportType])
  @@index([uploadedAt])
  @@index([marketplace, startDate, endDate])
}

/// AdsDataRow stores daily spend by SKU (aggregated) for a single AdsDataUpload.
model AdsDataRow {
  id String @id @default(cuid())

  uploadId   String
  date       String // YYYY-MM-DD
  sku        String
  spendCents Int

  upload AdsDataUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@unique([uploadId, date, sku])
  @@index([uploadId])
  @@index([uploadId, date])
  @@index([sku])
}

/// SettlementAdsAllocation stores a SKU-level split of the settlement's lump "Amazon Advertising Costs" amount.
/// This is used for internal analytics; it should not explode transactions in QBO.
model SettlementAdsAllocation {
  id String @id @default(cuid())

  settlementProcessingId String @unique

  weightSource String // e.g., "SPONSORED_PRODUCTS_SPEND"
  weightUnit   String // e.g., "cents", "units"

  invoiceStartDate String // YYYY-MM-DD
  invoiceEndDate   String // YYYY-MM-DD

  totalAdsCents Int
  adsDataUploadId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  settlementProcessing SettlementProcessing @relation(fields: [settlementProcessingId], references: [id], onDelete: Cascade)
  adsDataUpload        AdsDataUpload?       @relation(fields: [adsDataUploadId], references: [id])

  lines SettlementAdsAllocationLine[]

  @@index([settlementProcessingId])
  @@index([adsDataUploadId])
}

model SettlementAdsAllocationLine {
  id String @id @default(cuid())

  settlementAdsAllocationId String
  sku           String
  weight        Int
  allocatedCents Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  settlementAdsAllocation SettlementAdsAllocation @relation(fields: [settlementAdsAllocationId], references: [id], onDelete: Cascade)

  @@unique([settlementAdsAllocationId, sku])
  @@index([settlementAdsAllocationId])
  @@index([sku])
}

/// CashflowForecastConfig stores the global forecast settings for the 13-week cashflow view.
model CashflowForecastConfig {
  id String @id @default(cuid())

  cashAccountIds                String[]
  weekStartsOn                  Int     @default(1)
  settlementLookbackDays        Int     @default(180)
  settlementAverageCount        Int     @default(4)
  settlementDefaultIntervalDays Int     @default(14)
  includeProjectedSettlements   Boolean @default(true)
  includeOpenBills              Boolean @default(true)
  includeOpenInvoices           Boolean @default(true)
  includeRecurring              Boolean @default(true)
  autoRefreshEnabled            Boolean @default(true)
  autoRefreshTimeLocal          String  @default("06:00")
  autoRefreshMinSnapshotAgeMinutes Int  @default(720)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// CashflowForecastAdjustment stores user-entered cashflow lines.
model CashflowForecastAdjustment {
  id String @id @default(cuid())

  date        String
  amountCents Int
  description String
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

/// CashflowForecastSnapshot stores immutable generated snapshots rendered by the UI.
model CashflowForecastSnapshot {
  id String @id @default(cuid())

  asOfDate  String
  config    Json
  inputs    Json
  forecast  Json
  warnings  Json?
  createdAt DateTime @default(now())

  @@index([createdAt])
}
