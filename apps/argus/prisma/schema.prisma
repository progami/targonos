generator client {
  provider = "prisma-client-js"
  output   = "../../../packages/prisma-argus/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Marketplace {
  US
  UK
}

enum WatchTargetOwner {
  OURS
  COMPETITOR
}

enum WatchTargetSource {
  MANUAL
  TALOS
}

enum CaptureJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  BLOCKED
}

enum ArtifactKind {
  ASIN_FULLPAGE
}

enum ImportRunStatus {
  RUNNING
  SUCCESS
  FAILED
}

enum ImportSource {
  TALOS
}

model WatchTarget {
  id             String            @id @default(cuid())
  marketplace    Marketplace
  owner          WatchTargetOwner
  source         WatchTargetSource @default(MANUAL)
  label          String

  asin           String

  cadenceMinutes Int               @default(360)
  enabled        Boolean           @default(true)
  nextRunAt      DateTime
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  activeImageVersionId String?
  activeImageVersion   ListingImageVersion?   @relation("TargetActiveImageVersion", fields: [activeImageVersionId], references: [id], onDelete: SetNull)
  imageVersions        ListingImageVersion[]  @relation("TargetImageVersions")

  jobs           CaptureJob[]
  runs           CaptureRun[]
  alertRules     AlertRule[]

  @@unique([marketplace, asin])
  @@index([marketplace])
  @@index([owner])
  @@index([source])
  @@index([enabled])
  @@index([nextRunAt])
  @@index([activeImageVersionId])
}

model CaptureJob {
  id           String           @id @default(cuid())
  targetId     String
  target       WatchTarget      @relation(fields: [targetId], references: [id], onDelete: Cascade)
  scheduledAt  DateTime
  status       CaptureJobStatus @default(QUEUED)
  lockedAt     DateTime?
  lockedBy     String?
  attemptCount Int              @default(0)
  lastError    String?
  startedAt    DateTime?
  finishedAt   DateTime?
  runId        String?
  run          CaptureRun?      @relation(fields: [runId], references: [id], onDelete: SetNull)
  acknowledgedAt         DateTime?
  acknowledgedByUserId   String?
  acknowledgedByEmail    String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([status, scheduledAt])
  @@index([targetId])
  @@index([scheduledAt])
}

model CaptureRun {
  id                   String       @id @default(cuid())
  targetId             String
  target               WatchTarget  @relation(fields: [targetId], references: [id], onDelete: Cascade)
  startedAt            DateTime     @default(now())
  finishedAt           DateTime?
  finalUrl             String
  contentHash          String
  rawExtracted         Json?
  normalizedExtracted  Json?
  changedFromRunId     String?
  changedFromRun       CaptureRun?  @relation("ChangedFrom", fields: [changedFromRunId], references: [id], onDelete: SetNull)
  changedToRuns        CaptureRun[] @relation("ChangedFrom")
  changeSummary        Json?
  acknowledgedAt         DateTime?
  acknowledgedByUserId   String?
  acknowledgedByEmail    String?
  notes                String?

  artifacts            RunArtifact[]
  jobs                 CaptureJob[]
  alertEvents          AlertEvent[]

  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([targetId, startedAt])
  @@index([startedAt])
}

model RunArtifact {
  id          String       @id @default(cuid())
  runId       String
  run         CaptureRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  kind        ArtifactKind
  marketplace Marketplace
  asin        String?
  position    Int?
  s3Key       String
  sha256      String
  createdAt   DateTime     @default(now())

  @@index([runId])
  @@index([kind])
}

model AlertRule {
  id         String      @id @default(cuid())
  targetId   String      @unique
  target     WatchTarget @relation(fields: [targetId], references: [id], onDelete: Cascade)
  enabled    Boolean     @default(true)
  thresholds Json
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  events     AlertEvent[]
}

model AlertEvent {
  id          String     @id @default(cuid())
  ruleId      String
  rule        AlertRule  @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  runId       String
  run         CaptureRun @relation(fields: [runId], references: [id], onDelete: Restrict)
  sentAt      DateTime   @default(now())
  toEmails    String[]   @default([])
  subject     String
  bodyPreview String
  acknowledgedAt         DateTime?
  acknowledgedByUserId   String?
  acknowledgedByEmail    String?

  @@unique([ruleId, runId])
  @@index([sentAt])
  @@index([runId])
}

model ImportRun {
  id           String          @id @default(cuid())
  source       ImportSource
  status       ImportRunStatus @default(RUNNING)
  startedAt    DateTime        @default(now())
  finishedAt   DateTime?
  createdCount Int             @default(0)
  updatedCount Int             @default(0)
  skippedCount Int             @default(0)
  error        String?
  details      Json?
  updatedAt    DateTime        @updatedAt

  @@index([startedAt])
  @@index([status])
  @@index([source])
}

model ListingImageBlob {
  sha256      String   @id
  s3Key       String
  contentType String
  byteSize    Int
  width       Int
  height      Int
  createdAt   DateTime @default(now())

  slots       ListingImageVersionSlot[]
}

model ListingImageVersion {
  id            String   @id @default(cuid())
  targetId      String
  target        WatchTarget @relation("TargetImageVersions", fields: [targetId], references: [id], onDelete: Cascade)
  versionNumber Int
  label         String?
  notes         String?
  createdByUserId String
  createdByEmail  String?
  createdAt     DateTime @default(now())

  slots         ListingImageVersionSlot[]
  activeForTargets WatchTarget[] @relation("TargetActiveImageVersion")

  @@unique([targetId, versionNumber])
  @@index([targetId, createdAt])
}

model ListingImageVersionSlot {
  id        String   @id @default(cuid())
  versionId String
  version   ListingImageVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  position  Int
  fileName  String
  blobSha256 String
  blob      ListingImageBlob @relation(fields: [blobSha256], references: [sha256], onDelete: Restrict)
  createdAt DateTime @default(now())

  @@unique([versionId, position])
  @@index([versionId])
  @@index([blobSha256])
}
