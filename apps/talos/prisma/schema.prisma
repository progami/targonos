generator client {
  provider = "prisma-client-js"
  output   = "../../../packages/prisma-talos/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  username         String?          @unique
  passwordHash     String           @map("password_hash")
  fullName         String           @map("full_name")
  role             UserRole         @default(staff)
  region           TenantCode       @default(US)
  warehouseId      String?          @map("warehouse_id")
  isActive         Boolean          @default(true) @map("is_active")
  isDemo           Boolean          @default(false) @map("is_demo")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  lastLoginAt      DateTime?        @map("last_login_at")
  lockedUntil      DateTime?        @map("locked_until")
  lockedReason     String?          @map("locked_reason")
  auditLogs        AuditLog[]
  createdCostRates CostRate[]
  warehouse        Warehouse?       @relation(fields: [warehouseId], references: [id])
  permissions      UserPermission[]

  @@index([email])
  @@index([warehouseId])
  @@map("users")
}

model Permission {
  id          String           @id @default(uuid())
  code        String           @unique
  name        String
  description String?
  category    String
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  users       UserPermission[]

  @@index([category])
  @@map("permissions")
}

model UserPermission {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  permissionId String     @map("permission_id")
  grantedById  String     @map("granted_by_id")
  grantedAt    DateTime   @default(now()) @map("granted_at")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@map("user_permissions")
}

model Warehouse {
  id                 String     @id @default(uuid())
  code               String     @unique
  name               String
  address            String?
  latitude           Float?     @map("latitude")
  longitude          Float?     @map("longitude")
  contactEmail       String?    @map("contact_email")
  contactPhone       String?    @map("contact_phone")
  kind               WarehouseKind @default(THIRD_PARTY) @map("kind")
  isActive           Boolean    @default(true) @map("is_active")
  rateListAttachment Json?      @map("rate_list_attachment")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")
  costRates          CostRate[]
  forwardingCosts    PurchaseOrderForwardingCost[]
  skuStorageConfigs  WarehouseSkuStorageConfig[]
  users              User[]

  @@index([code])
  @@map("warehouses")
}

model Sku {
  id                  String     @id @default(uuid())
  skuCode             String     @unique @map("sku_code")
  asin                String?
  category             String?    @map("category")
  subcategory          String?    @map("subcategory")
  sizeTier             String?    @map("size_tier")
  referralFeePercent   Decimal?   @map("referral_fee_percent") @db.Decimal(5, 2)
  fbaFulfillmentFee    Decimal?   @map("fba_fulfillment_fee") @db.Decimal(12, 2)
  amazonCategory       String?    @map("amazon_category")
  amazonSubcategory    String?    @map("amazon_subcategory")
  amazonSizeTier       String?    @map("amazon_size_tier")
  amazonReferralFeePercent Decimal? @map("amazon_referral_fee_percent") @db.Decimal(5, 2)
  amazonFbaFulfillmentFee Decimal? @map("amazon_fba_fulfillment_fee") @db.Decimal(12, 2)
  amazonListingPrice   Decimal?   @map("amazon_listing_price") @db.Decimal(12, 2)
  amazonReferenceWeightKg Decimal? @map("amazon_reference_weight_kg") @db.Decimal(8, 3)
  description         String     @db.VarChar(42)
  packSize            Int?       @map("pack_size")
  defaultSupplierId   String?    @map("default_supplier_id")
  secondarySupplierId String?    @map("secondary_supplier_id")
  defaultSupplier     Supplier?  @relation("SkuDefaultSupplier", fields: [defaultSupplierId], references: [id], onDelete: SetNull)
  secondarySupplier   Supplier?  @relation("SkuSecondarySupplier", fields: [secondarySupplierId], references: [id], onDelete: SetNull)
  material            String?
  unitDimensionsCm    String?    @map("unit_dimensions_cm")
  unitSide1Cm         Decimal?   @map("unit_side1_cm") @db.Decimal(8, 2)
  unitSide2Cm         Decimal?   @map("unit_side2_cm") @db.Decimal(8, 2)
  unitSide3Cm         Decimal?   @map("unit_side3_cm") @db.Decimal(8, 2)
  unitWeightKg        Decimal?   @map("unit_weight_kg") @db.Decimal(8, 3)
  itemDimensionsCm    String?    @map("item_dimensions_cm")
  itemSide1Cm         Decimal?   @map("item_side1_cm") @db.Decimal(8, 2)
  itemSide2Cm         Decimal?   @map("item_side2_cm") @db.Decimal(8, 2)
  itemSide3Cm         Decimal?   @map("item_side3_cm") @db.Decimal(8, 2)
  itemWeightKg        Decimal?   @map("item_weight_kg") @db.Decimal(8, 3)
  amazonItemPackageDimensionsCm String? @map("amazon_item_package_dimensions_cm")
  amazonItemPackageSide1Cm Decimal? @map("amazon_item_package_side1_cm") @db.Decimal(8, 2)
  amazonItemPackageSide2Cm Decimal? @map("amazon_item_package_side2_cm") @db.Decimal(8, 2)
  amazonItemPackageSide3Cm Decimal? @map("amazon_item_package_side3_cm") @db.Decimal(8, 2)
  amazonItemDimensionsCm String? @map("amazon_item_dimensions_cm")
  amazonItemSide1Cm      Decimal? @map("amazon_item_side1_cm") @db.Decimal(8, 2)
  amazonItemSide2Cm      Decimal? @map("amazon_item_side2_cm") @db.Decimal(8, 2)
  amazonItemSide3Cm      Decimal? @map("amazon_item_side3_cm") @db.Decimal(8, 2)
  amazonItemWeightKg     Decimal? @map("amazon_item_weight_kg") @db.Decimal(8, 3)
  unitsPerCarton      Int        @default(1) @map("units_per_carton")
  cartonDimensionsCm  String?    @map("carton_dimensions_cm")
  cartonSide1Cm       Decimal?   @map("carton_side1_cm") @db.Decimal(8, 2)
  cartonSide2Cm       Decimal?   @map("carton_side2_cm") @db.Decimal(8, 2)
  cartonSide3Cm       Decimal?   @map("carton_side3_cm") @db.Decimal(8, 2)
  cartonWeightKg      Decimal?   @map("carton_weight_kg") @db.Decimal(8, 3)
  packagingType       String?    @map("packaging_type")
  isActive            Boolean    @default(true) @map("is_active")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
  fbaStock            Int?       @map("fba_stock")
  fbaStockLastUpdated DateTime?  @map("fba_stock_last_updated")
  batches             SkuBatch[]
  warehouseStorageConfigs WarehouseSkuStorageConfig[]
  amazonFbaFeeAlert   AmazonFbaFeeAlert?

  @@index([skuCode])
  @@index([asin])
  @@index([defaultSupplierId])
  @@index([secondarySupplierId])
  @@map("skus")
}

model AmazonFbaFeeAlert {
  id                         String                   @id @default(uuid())
  skuId                      String                   @unique @map("sku_id")
  sku                        Sku                      @relation(fields: [skuId], references: [id], onDelete: Cascade)
  referenceSizeTier          String?                  @map("reference_size_tier")
  referenceFbaFulfillmentFee Decimal?                 @map("reference_fba_fulfillment_fee") @db.Decimal(12, 2)
  amazonFbaFulfillmentFee    Decimal?                 @map("amazon_fba_fulfillment_fee") @db.Decimal(12, 2)
  currencyCode               String?                  @map("currency_code")
  listingPrice               Decimal?                 @map("listing_price") @db.Decimal(12, 2)
  status                     AmazonFbaFeeAlertStatus  @default(UNKNOWN)
  message                    String?                  @map("message")
  checkedAt                  DateTime?                @map("checked_at")
  createdAt                  DateTime                 @default(now()) @map("created_at")
  updatedAt                  DateTime                 @updatedAt @map("updated_at")

  @@index([status])
  @@index([checkedAt])
  @@map("amazon_fba_fee_alerts")
}

model WarehouseSkuStorageConfig {
  id                       String   @id @default(uuid())
  warehouseId              String   @map("warehouse_id")
  skuId                    String   @map("sku_id")
  storageCartonsPerPallet  Int?     @map("storage_cartons_per_pallet")
  shippingCartonsPerPallet Int?     @map("shipping_cartons_per_pallet")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  sku       Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, skuId])
  @@index([warehouseId])
  @@index([skuId])
  @@map("warehouse_sku_storage_configs")
}

model SkuBatch {
  id                       String    @id @default(uuid())
  skuId                    String    @map("sku_id")
  sku                      Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)
  batchCode                String    @map("batch_code")
  description              String?   @map("description")
  productionDate           DateTime? @map("production_date")
  expiryDate               DateTime? @map("expiry_date")
  packSize                 Int?      @map("pack_size")
  unitsPerCarton           Int?      @map("units_per_carton")
  material                 String?   @map("material")
  cartonDimensionsCm       String?   @map("carton_dimensions_cm")
  cartonSide1Cm            Decimal?  @map("carton_side1_cm") @db.Decimal(8, 2)
  cartonSide2Cm            Decimal?  @map("carton_side2_cm") @db.Decimal(8, 2)
  cartonSide3Cm            Decimal?  @map("carton_side3_cm") @db.Decimal(8, 2)
  cartonWeightKg           Decimal?  @map("carton_weight_kg") @db.Decimal(8, 3)
  packagingType            String?   @map("packaging_type")
  amazonSizeTier           String?   @map("amazon_size_tier")
  amazonFbaFulfillmentFee  Decimal?  @map("amazon_fba_fulfillment_fee") @db.Decimal(12, 2)
  amazonReferenceWeightKg  Decimal?  @map("amazon_reference_weight_kg") @db.Decimal(8, 3)
  storageCartonsPerPallet  Int?      @map("storage_cartons_per_pallet")
  shippingCartonsPerPallet Int?      @map("shipping_cartons_per_pallet")
  isActive                 Boolean   @default(true) @map("is_active")
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")

  @@unique([skuId, batchCode])
  @@map("sku_batches")
}

model Supplier {
  id            String   @id @default(uuid())
  name          String   @map("name")
  contactName   String?  @map("contact_name")
  email         String?  @map("email")
  phone         String?  @map("phone")
  address       String?  @map("address")
  notes         String?
  defaultPaymentTerms String?  @map("default_payment_terms")
  defaultIncoterms    String?  @map("default_incoterms")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  defaultSkus   Sku[]    @relation("SkuDefaultSupplier")
  secondarySkus Sku[]    @relation("SkuSecondarySupplier")

  @@unique([name])
  @@index([isActive])
  @@map("suppliers")
}

model CostRate {
  id            String       @id @default(uuid())
  warehouseId   String       @map("warehouse_id")
  costCategory  CostCategory @map("cost_category")
  costName      String       @map("cost_name")
  costValue     Decimal      @map("cost_value") @db.Decimal(12, 2)
  unitOfMeasure String       @map("unit_of_measure")
  effectiveDate DateTime     @map("effective_date") @db.Date
  endDate       DateTime?    @map("end_date") @db.Date
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  createdById   String       @map("created_by")
  createdBy     User         @relation(fields: [createdById], references: [id])
  warehouse     Warehouse    @relation(fields: [warehouseId], references: [id])
  purchaseOrderForwardingCosts PurchaseOrderForwardingCost[]

  @@unique([warehouseId, costName, effectiveDate])
  @@index([warehouseId, costName, effectiveDate])
  @@map("cost_rates")
}

model InventoryTransaction {
  id                       String             @id @default(uuid())
  // Warehouse snapshot data
  warehouseCode            String             @map("warehouse_code")
  warehouseName            String             @map("warehouse_name")
  warehouseAddress         String?            @map("warehouse_address")
  // SKU snapshot data
  skuCode                  String             @map("sku_code")
  skuDescription           String             @map("sku_description")
  unitDimensionsCm         String?            @map("unit_dimensions_cm")
  unitWeightKg             Decimal?           @map("unit_weight_kg") @db.Decimal(8, 3)
  cartonDimensionsCm       String?            @map("carton_dimensions_cm")
  cartonWeightKg           Decimal?           @map("carton_weight_kg") @db.Decimal(8, 3)
  packagingType            String?            @map("packaging_type")
  unitsPerCarton           Int                @map("units_per_carton")
  // Transaction data
  batchLot                 String             @map("batch_lot")
  transactionType          TransactionType    @map("transaction_type")
  referenceId              String?            @map("reference_id")
  cartonsIn                Int                @default(0) @map("cartons_in")
  cartonsOut               Int                @default(0) @map("cartons_out")
  storagePalletsIn         Int                @default(0) @map("storage_pallets_in")
  shippingPalletsOut       Int                @default(0) @map("shipping_pallets_out")
  transactionDate          DateTime           @map("transaction_date")
  pickupDate               DateTime?          @map("pickup_date")
  isReconciled             Boolean            @default(false) @map("is_reconciled")
  isDemo                   Boolean            @default(false) @map("is_demo")
  createdAt                DateTime           @default(now()) @map("created_at")
  createdById              String             @map("created_by")
  createdByName            String             @map("created_by_name")
  shippingCartonsPerPallet Int?               @map("shipping_cartons_per_pallet")
  storageCartonsPerPallet  Int?               @map("storage_cartons_per_pallet")
  shipName                 String?            @map("ship_name")
  trackingNumber           String?            @map("tracking_number")
  attachments              Json?
  supplier                 String?            @map("supplier")
  purchaseOrderId          String?            @map("purchase_order_id")
  purchaseOrderLineId      String?            @map("purchase_order_line_id")
  fulfillmentOrderId       String?            @map("fulfillment_order_id")
  fulfillmentOrderLineId   String?            @map("fulfillment_order_line_id")
  purchaseOrder            PurchaseOrder?     @relation("TransactionPurchaseOrder", fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  purchaseOrderLine        PurchaseOrderLine? @relation("TransactionPurchaseOrderLine", fields: [purchaseOrderLineId], references: [id], onDelete: SetNull)
  fulfillmentOrder         FulfillmentOrder?  @relation("TransactionFulfillmentOrder", fields: [fulfillmentOrderId], references: [id], onDelete: SetNull)
  fulfillmentOrderLine     FulfillmentOrderLine? @relation("TransactionFulfillmentOrderLine", fields: [fulfillmentOrderLineId], references: [id], onDelete: SetNull)
  costLedger               CostLedger[]

  @@index([transactionDate])
  @@index([warehouseCode, skuCode, batchLot])
  @@index([transactionDate(sort: Desc)], map: "idx_inventory_transactions_date")
  @@index([warehouseCode, skuCode, batchLot], map: "idx_inventory_transactions_warehouse_sku_batch")
  @@index([createdAt(sort: Desc)], map: "idx_inventory_transactions_created_at")
  @@index([purchaseOrderId], map: "idx_inventory_transactions_purchase_order")
  @@index([purchaseOrderLineId], map: "idx_inventory_transactions_purchase_order_line")
  @@index([fulfillmentOrderId], map: "idx_inventory_transactions_fulfillment_order")
  @@index([fulfillmentOrderLineId], map: "idx_inventory_transactions_fulfillment_order_line")
  @@map("inventory_transactions")
}

model PurchaseOrder {
  id               String              @id @default(uuid())
  orderNumber      String              @map("order_number")
  poNumber         String?             @unique @map("po_number") // Auto-generated PO-0001 format
  type             PurchaseOrderType
  status           PurchaseOrderStatus @default(DRAFT)
  counterpartyName String?             @map("counterparty_name")
  counterpartyAddress String?          @map("counterparty_address")
  notes            String?
  createdById      String?             @map("created_by")
  createdByName    String?             @map("created_by_name")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  isLegacy         Boolean             @default(false) @map("is_legacy")

  // ===========================================
  // STAGE 1: ISSUED (supplier-facing essentials)
  // ===========================================
  expectedDate       DateTime?           @map("expected_date")
  incoterms          String?             @map("incoterms")
  paymentTerms       String?             @map("payment_terms")

  // Legacy fields (kept for backward compatibility)
  postedAt           DateTime?           @map("posted_at")
  receiveType        InboundReceiveType? @map("receive_type")
  shipMode           OutboundShipMode?   @map("ship_mode")
  expectedCartons    Int?                @map("expected_cartons")
  expectedPallets    Int?                @map("expected_pallets")
  expectedSkuCount   Int?                @map("expected_sku_count")
  estimatedTotalCost Decimal?            @map("estimated_total_cost") @db.Decimal(12, 2)
  actualTotalCost    Decimal?            @map("actual_total_cost") @db.Decimal(12, 2)

  // ===========================================
  // STAGE 2: MANUFACTURING
  // ===========================================
  proformaInvoiceNumber  String?   @map("proforma_invoice_number")
  proformaInvoiceDate    DateTime? @map("proforma_invoice_date")
  factoryName            String?   @map("factory_name")
  manufacturingStartDate DateTime? @map("manufacturing_start_date")
  expectedCompletionDate DateTime? @map("expected_completion_date")
  actualCompletionDate   DateTime? @map("actual_completion_date")
  // Cargo specs (flat fields)
  totalWeightKg          Decimal?  @map("total_weight_kg") @db.Decimal(10, 2)
  totalVolumeCbm         Decimal?  @map("total_volume_cbm") @db.Decimal(10, 3)
  totalCartons           Int?      @map("total_cartons")
  totalPallets           Int?      @map("total_pallets")
  packagingNotes         String?   @map("packaging_notes")

  // ===========================================
  // STAGE 3: OCEAN
  // ===========================================
  houseBillOfLading       String?   @map("house_bill_of_lading")
  masterBillOfLading      String?   @map("master_bill_of_lading")
  commercialInvoiceNumber String?   @map("commercial_invoice_number")
  packingListRef          String?   @map("packing_list_ref")
  vesselName              String?   @map("vessel_name")
  voyageNumber            String?   @map("voyage_number")
  portOfLoading           String?   @map("port_of_loading")
  portOfDischarge         String?   @map("port_of_discharge")
  estimatedDeparture      DateTime? @map("estimated_departure")
  estimatedArrival        DateTime? @map("estimated_arrival")
  actualDeparture         DateTime? @map("actual_departure")
  actualArrival           DateTime? @map("actual_arrival")

  // ===========================================
  // STAGE 4: WAREHOUSE (warehouse selected here)
  // ===========================================
  warehouseCode         String?   @map("warehouse_code")
  warehouseName         String?   @map("warehouse_name")
  customsEntryNumber    String?   @map("customs_entry_number")
  customsClearedDate    DateTime? @map("customs_cleared_date")
  dutyAmount            Decimal?  @map("duty_amount") @db.Decimal(10, 2)
  dutyCurrency          String?   @map("duty_currency")
  surrenderBlDate       DateTime? @map("surrender_bl_date")
  transactionCertNumber String?   @map("transaction_cert_number")
  receivedDate          DateTime? @map("received_date")
  discrepancyNotes      String?   @map("discrepancy_notes")

  // ===========================================
  // STAGE 5: SHIPPED
  // ===========================================
  shipToName         String?   @map("ship_to_name")
  shipToAddress      String?   @map("ship_to_address")
  shipToCity         String?   @map("ship_to_city")
  shipToCountry      String?   @map("ship_to_country")
  shipToPostalCode   String?   @map("ship_to_postal_code")
  shippingCarrier    String?   @map("shipping_carrier")
  shippingMethod     String?   @map("shipping_method")
  trackingNumber     String?   @map("tracking_number")
  shippedDate        DateTime? @map("shipped_date")
  proofOfDeliveryRef String?   @map("proof_of_delivery_ref")
  deliveredDate      DateTime? @map("delivered_date")

  // ===========================================
  // STAGE APPROVAL TRACKING
  // ===========================================
  draftApprovedAt             DateTime? @map("draft_approved_at")
  draftApprovedById           String?   @map("draft_approved_by_id")
  draftApprovedByName         String?   @map("draft_approved_by_name")
  manufacturingApprovedAt     DateTime? @map("manufacturing_approved_at")
  manufacturingApprovedById   String?   @map("manufacturing_approved_by_id")
  manufacturingApprovedByName String?   @map("manufacturing_approved_by_name")
  oceanApprovedAt             DateTime? @map("ocean_approved_at")
  oceanApprovedById           String?   @map("ocean_approved_by_id")
  oceanApprovedByName         String?   @map("ocean_approved_by_name")
  warehouseApprovedAt         DateTime? @map("warehouse_approved_at")
  warehouseApprovedById       String?   @map("warehouse_approved_by_id")
  warehouseApprovedByName     String?   @map("warehouse_approved_by_name")
  shippedApprovedAt           DateTime? @map("shipped_approved_at")
  shippedApprovedById         String?   @map("shipped_approved_by_id")
  shippedApprovedByName       String?   @map("shipped_approved_by_name")

  // Legacy fields (for old schema compatibility)
  proformaInvoiceId      String?   @map("proforma_invoice_id")
  proformaInvoiceData    Json?     @map("proforma_invoice_data")
  manufacturingStart     DateTime? @map("manufacturing_start")
  manufacturingEnd       DateTime? @map("manufacturing_end")
  cargoDetails           Json?     @map("cargo_details")
  commercialInvoiceId    String?   @map("commercial_invoice_id")
  warehouseInvoiceId     String?   @map("warehouse_invoice_id")
  surrenderBL            String?   @map("surrender_bl")
  transactionCertificate String?   @map("transaction_certificate")
  customsDeclaration     String?   @map("customs_declaration")
  proofOfDelivery        String?   @map("proof_of_delivery")
  shippedAt              DateTime? @map("shipped_at")
  shippedById            String?   @map("shipped_by_id")
  shippedByName          String?   @map("shipped_by_name")

  lines         PurchaseOrderLine[]
  containers    PurchaseOrderContainer[]
  documents     PurchaseOrderDocument[]
  transactions  InventoryTransaction[]   @relation("TransactionPurchaseOrder")
  movementNotes MovementNote[]
  invoiceLines  WarehouseInvoiceLine[]   @relation("WarehouseInvoiceLinePurchaseOrder")
  forwardingCosts PurchaseOrderForwardingCost[]

  @@unique([orderNumber])
  @@index([status])
  @@index([type, status])
  @@index([isLegacy])
  @@index([warehouseCode])
  @@map("purchase_orders")
}

model FulfillmentOrder {
  id                  String                 @id @default(uuid())
  foNumber             String                 @unique @map("fo_number") // FO-0001 format
  status               FulfillmentOrderStatus @default(DRAFT)
  warehouseCode        String                 @map("warehouse_code")
  warehouseName        String                 @map("warehouse_name")
  destinationType      FulfillmentDestinationType @default(CUSTOMER) @map("destination_type")
  destinationName      String?                @map("destination_name")
  destinationAddress   String?                @map("destination_address")
  destinationCountry   String?                @map("destination_country")
  shippingCarrier      String?                @map("shipping_carrier")
  shippingMethod       String?                @map("shipping_method")
  trackingNumber       String?                @map("tracking_number")
  shippedDate          DateTime?              @map("shipped_date")
  deliveredDate        DateTime?              @map("delivered_date")
  externalReference    String?                @map("external_reference")
  amazonShipmentId     String?                @map("amazon_shipment_id")
  amazonShipmentName   String?                @map("amazon_shipment_name")
  amazonShipmentStatus String?                @map("amazon_shipment_status")
  amazonDestinationFulfillmentCenterId String? @map("amazon_destination_fulfillment_center_id")
  amazonLabelPrepType  String?                @map("amazon_label_prep_type")
  amazonBoxContentsSource String?             @map("amazon_box_contents_source")
  amazonShipFromAddress Json?                 @map("amazon_ship_from_address")
  amazonReferenceId    String?                @map("amazon_reference_id")
  amazonShipmentReference String?             @map("amazon_shipment_reference")
  amazonShipperId      String?                @map("amazon_shipper_id")
  amazonPickupNumber   String?                @map("amazon_pickup_number")
  amazonPickupAppointmentId String?           @map("amazon_pickup_appointment_id")
  amazonDeliveryAppointmentId String?         @map("amazon_delivery_appointment_id")
  amazonLoadId         String?                @map("amazon_load_id")
  amazonFreightBillNumber String?             @map("amazon_freight_bill_number")
  amazonBillOfLadingNumber String?            @map("amazon_bill_of_lading_number")
  amazonPickupWindowStart DateTime?           @map("amazon_pickup_window_start")
  amazonPickupWindowEnd DateTime?             @map("amazon_pickup_window_end")
  amazonDeliveryWindowStart DateTime?         @map("amazon_delivery_window_start")
  amazonDeliveryWindowEnd DateTime?           @map("amazon_delivery_window_end")
  amazonPickupAddress  String?                @map("amazon_pickup_address")
  amazonPickupContactName String?             @map("amazon_pickup_contact_name")
  amazonPickupContactPhone String?            @map("amazon_pickup_contact_phone")
  amazonDeliveryAddress String?               @map("amazon_delivery_address")
  amazonShipmentMode   String?                @map("amazon_shipment_mode")
  amazonBoxCount       Int?                   @map("amazon_box_count")
  amazonPalletCount    Int?                   @map("amazon_pallet_count")
  amazonCommodityDescription String?          @map("amazon_commodity_description")
  amazonDistanceMiles  Decimal?               @map("amazon_distance_miles") @db.Decimal(10, 2)
  amazonBasePrice      Decimal?               @map("amazon_base_price") @db.Decimal(12, 2)
  amazonFuelSurcharge  Decimal?               @map("amazon_fuel_surcharge") @db.Decimal(12, 2)
  amazonTotalPrice     Decimal?               @map("amazon_total_price") @db.Decimal(12, 2)
  amazonCurrency       String?                @map("amazon_currency")
  notes                String?
  createdById          String?                @map("created_by")
  createdByName        String?                @map("created_by_name")
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")

  lines                FulfillmentOrderLine[]
  documents            FulfillmentOrderDocument[]
  transactions         InventoryTransaction[] @relation("TransactionFulfillmentOrder")

  @@index([status])
  @@index([warehouseCode])
  @@index([amazonShipmentId])
  @@map("fulfillment_orders")
}

model FulfillmentOrderDocument {
  id                  String                    @id @default(uuid())
  fulfillmentOrderId  String                    @map("fulfillment_order_id")
  fulfillmentOrder    FulfillmentOrder          @relation(fields: [fulfillmentOrderId], references: [id], onDelete: Cascade)
  stage               FulfillmentOrderDocumentStage @map("stage")
  documentType        String                    @map("document_type")
  fileName            String                    @map("file_name")
  contentType         String                    @map("content_type")
  size                Int                       @map("size")
  s3Key               String                    @map("s3_key")
  uploadedAt          DateTime                  @default(now()) @map("uploaded_at")
  uploadedById        String?                   @map("uploaded_by_id")
  uploadedByName      String?                   @map("uploaded_by_name")
  metadata            Json?                     @map("metadata")

  @@unique([fulfillmentOrderId, stage, documentType])
  @@index([fulfillmentOrderId])
  @@index([stage])
  @@index([documentType])
  @@map("fulfillment_order_documents")
}

model FulfillmentOrderLine {
  id                 String                @id @default(uuid())
  fulfillmentOrderId String                @map("fulfillment_order_id")
  fulfillmentOrder   FulfillmentOrder      @relation(fields: [fulfillmentOrderId], references: [id], onDelete: Cascade)
  skuCode            String                @map("sku_code")
  skuDescription     String?               @map("sku_description")
  batchLot           String                @map("batch_lot")
  quantity           Int
  status             FulfillmentOrderLineStatus @default(PENDING)
  shippedQuantity    Int                   @default(0) @map("shipped_quantity")
  lineNotes          String?               @map("line_notes")
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  transactions       InventoryTransaction[] @relation("TransactionFulfillmentOrderLine")

  @@unique([fulfillmentOrderId, skuCode, batchLot])
  @@index([fulfillmentOrderId])
  @@map("fulfillment_order_lines")
}

model PurchaseOrderDocument {
  id              String                   @id @default(uuid())
  purchaseOrderId String                   @map("purchase_order_id")
  purchaseOrder   PurchaseOrder            @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  stage           PurchaseOrderDocumentStage @map("stage")
  documentType    String                   @map("document_type")
  fileName        String                   @map("file_name")
  contentType     String                   @map("content_type")
  size            Int                      @map("size")
  s3Key           String                   @map("s3_key")
  uploadedAt      DateTime                 @default(now()) @map("uploaded_at")
  uploadedById    String?                  @map("uploaded_by_id")
  uploadedByName  String?                  @map("uploaded_by_name")
  metadata        Json?                    @map("metadata")

  @@unique([purchaseOrderId, stage, documentType])
  @@index([purchaseOrderId])
  @@index([stage])
  @@index([documentType])
  @@map("purchase_order_documents")
}

model PurchaseOrderForwardingCost {
  id              String   @id @default(uuid())
  purchaseOrderId String   @map("purchase_order_id")
  warehouseId     String   @map("warehouse_id")
  costRateId      String?  @map("cost_rate_id")
  costName        String   @map("cost_name")
  quantity        Decimal  @db.Decimal(12, 4)
  unitRate        Decimal  @map("unit_rate") @db.Decimal(12, 4)
  totalCost       Decimal  @map("total_cost") @db.Decimal(12, 2)
  currency        String?
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdById     String?  @map("created_by_id")
  createdByName   String?  @map("created_by_name")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  warehouse     Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  costRate      CostRate?     @relation(fields: [costRateId], references: [id], onDelete: SetNull)

  @@index([purchaseOrderId])
  @@index([warehouseId])
  @@index([costRateId])
  @@map("purchase_order_forwarding_costs")
}

model PurchaseOrderLine {
  id                String                  @id @default(uuid())
  purchaseOrderId   String                  @map("purchase_order_id")
  purchaseOrder     PurchaseOrder           @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  skuCode           String                  @map("sku_code")
  skuDescription    String?                 @map("sku_description")
  batchLot          String?                 @map("batch_lot")
  cartonDimensionsCm String?                @map("carton_dimensions_cm")
  cartonSide1Cm      Decimal?               @map("carton_side1_cm") @db.Decimal(8, 2)
  cartonSide2Cm      Decimal?               @map("carton_side2_cm") @db.Decimal(8, 2)
  cartonSide3Cm      Decimal?               @map("carton_side3_cm") @db.Decimal(8, 2)
  cartonWeightKg     Decimal?               @map("carton_weight_kg") @db.Decimal(8, 3)
  packagingType      String?                @map("packaging_type")
  storageCartonsPerPallet  Int?             @map("storage_cartons_per_pallet")
  shippingCartonsPerPallet Int?             @map("shipping_cartons_per_pallet")
  unitsOrdered      Int                     @map("units_ordered")
  unitsPerCarton    Int                     @map("units_per_carton")
  quantity          Int
  unitCost          Decimal?                @map("unit_cost") @db.Decimal(12, 4)
  totalCost         Decimal?                @map("total_cost") @db.Decimal(12, 2)
  currency          String                  @default("USD")
  status            PurchaseOrderLineStatus @default(PENDING)
  postedQuantity    Int                     @default(0) @map("posted_quantity")
  quantityReceived  Int?                    @map("quantity_received") // Filled at WAREHOUSE stage
  lineNotes         String?                 @map("line_notes")
  createdAt         DateTime                @default(now()) @map("created_at")
  updatedAt         DateTime                @updatedAt @map("updated_at")
  transactions      InventoryTransaction[]  @relation("TransactionPurchaseOrderLine")
  movementNoteLines MovementNoteLine[]
  invoiceLines      WarehouseInvoiceLine[]

  @@unique([purchaseOrderId, skuCode, batchLot])
  @@index([purchaseOrderId])
  @@map("purchase_order_lines")
}

model PurchaseOrderContainer {
  id              String        @id @default(uuid())
  purchaseOrderId String        @map("purchase_order_id")
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  containerNumber String        @map("container_number")
  containerSize   String        @map("container_size") // 20FT, 40FT, 40HC, 45HC
  sealNumber      String?       @map("seal_number")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@unique([purchaseOrderId, containerNumber])
  @@index([purchaseOrderId])
  @@map("purchase_order_containers")
}

model MovementNote {
  id              String             @id @default(uuid())
  purchaseOrderId String             @map("purchase_order_id")
  purchaseOrder   PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  status          MovementNoteStatus @default(DRAFT)
  referenceNumber String?            @map("reference_number")
  receivedAt      DateTime           @default(now()) @map("received_at")
  receivedById    String?            @map("received_by_id")
  receivedByName  String?            @map("received_by_name")
  warehouseId     String?            @map("warehouse_id")
  warehouseCode   String             @map("warehouse_code")
  warehouseName   String             @map("warehouse_name")
  notes           String?
  attachments     Json?              @map("attachments")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  lines           MovementNoteLine[]

  @@index([purchaseOrderId])
  @@index([warehouseCode])
  @@map("goods_receipts")
}

model MovementNoteLine {
  id                       String                 @id @default(uuid())
  movementNoteId           String                 @map("goods_receipt_id")
  movementNote             MovementNote           @relation(fields: [movementNoteId], references: [id], onDelete: Cascade)
  purchaseOrderLineId      String?                @map("purchase_order_line_id")
  purchaseOrderLine        PurchaseOrderLine?     @relation(fields: [purchaseOrderLineId], references: [id], onDelete: SetNull)
  skuCode                  String                 @map("sku_code")
  skuDescription           String?                @map("sku_description")
  batchLot                 String?                @map("batch_lot")
  quantity                 Int
  varianceQuantity         Int                    @default(0) @map("variance_quantity")
  storageCartonsPerPallet  Int?                   @map("storage_cartons_per_pallet")
  shippingCartonsPerPallet Int?                   @map("shipping_cartons_per_pallet")
  attachments              Json?                  @map("attachments")
  createdAt                DateTime               @default(now()) @map("created_at")
  updatedAt                DateTime               @updatedAt @map("updated_at")
  invoiceLines             WarehouseInvoiceLine[]

  @@index([movementNoteId])
  @@index([purchaseOrderLineId])
  @@map("goods_receipt_lines")
}

model WarehouseInvoice {
  id            String                 @id @default(uuid())
  invoiceNumber String                 @map("invoice_number")
  status        WarehouseInvoiceStatus @default(DRAFT)
  issuedAt      DateTime?              @map("issued_at")
  dueAt         DateTime?              @map("due_at")
  warehouseId   String?                @map("warehouse_id")
  warehouseCode String                 @map("warehouse_code")
  warehouseName String                 @map("warehouse_name")
  currency      String                 @default("USD")
  subtotal      Decimal                @default(0) @map("subtotal") @db.Decimal(14, 2)
  total         Decimal                @default(0) @map("total") @db.Decimal(14, 2)
  notes         String?
  createdAt     DateTime               @default(now()) @map("created_at")
  updatedAt     DateTime               @updatedAt @map("updated_at")
  lines         WarehouseInvoiceLine[]

  @@index([invoiceNumber])
  @@index([status])
  @@index([warehouseCode])
  @@map("warehouse_invoices")
}

model WarehouseInvoiceLine {
  id                  String             @id @default(uuid())
  warehouseInvoiceId  String             @map("warehouse_invoice_id")
  warehouseInvoice    WarehouseInvoice   @relation(fields: [warehouseInvoiceId], references: [id], onDelete: Cascade)
  purchaseOrderId     String?            @map("purchase_order_id")
  purchaseOrder       PurchaseOrder?     @relation("WarehouseInvoiceLinePurchaseOrder", fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  purchaseOrderLineId String?            @map("purchase_order_line_id")
  purchaseOrderLine   PurchaseOrderLine? @relation(fields: [purchaseOrderLineId], references: [id], onDelete: SetNull)
  movementNoteLineId  String?            @map("goods_receipt_line_id")
  movementNoteLine    MovementNoteLine?  @relation(fields: [movementNoteLineId], references: [id], onDelete: SetNull)
  chargeCode          String             @map("charge_code")
  description         String?            @map("description")
  quantity            Decimal            @default(0) @map("quantity") @db.Decimal(14, 4)
  unitRate            Decimal            @default(0) @map("unit_rate") @db.Decimal(14, 4)
  total               Decimal            @default(0) @map("total") @db.Decimal(14, 2)
  varianceAmount      Decimal?           @map("variance_amount") @db.Decimal(14, 2)
  notes               String?
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  @@index([warehouseInvoiceId])
  @@index([purchaseOrderId])
  @@index([movementNoteLineId])
  @@map("warehouse_invoice_lines")
}

model StorageLedger {
  id               String   @id @default(uuid())
  storageLedgerId  String   @unique @map("storage_ledger_id")
  warehouseCode    String   @map("warehouse_code")
  warehouseName    String   @map("warehouse_name")
  skuCode          String   @map("sku_code")
  skuDescription   String   @map("sku_description")
  batchLot         String   @map("batch_lot")
  weekEndingDate   DateTime @map("week_ending_date") @db.Date
  openingBalance   Int      @map("opening_balance")
  weeklyReceive    Int      @map("weekly_receive")
  weeklyShip       Int      @map("weekly_ship")
  weeklyAdjust     Int      @map("weekly_adjust")
  closingBalance   Int      @map("closing_balance")
  averageBalance   Decimal  @map("average_balance") @db.Decimal(10, 2)
  dailyBalanceData Json?    @map("daily_balance_data")

  // Tactical storage methodology fields
  closingPallets Int @default(0) @map("closing_pallets")
  palletDays     Int @default(0) @map("pallet_days")

  // Storage cost fields
  storageRatePerPalletDay Decimal?  @map("storage_rate_per_pallet_day") @db.Decimal(10, 4)
  totalStorageCost        Decimal?  @map("total_storage_cost") @db.Decimal(12, 2)
  rateEffectiveDate       DateTime? @map("rate_effective_date") @db.Date
  costRateId              String?   @map("cost_rate_id")
  isCostCalculated        Boolean   @default(false) @map("is_cost_calculated")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  createdByName String   @map("created_by_name")

  @@unique([warehouseCode, skuCode, batchLot, weekEndingDate])
  @@index([warehouseCode, weekEndingDate])
  @@index([weekEndingDate, isCostCalculated])
  @@map("storage_ledger")
}

model CostLedger {
  id            String               @id @default(uuid())
  transactionId String               @map("transaction_id")
  costCategory  CostCategory         @map("cost_category")
  costName      String               @map("cost_name")
  quantity      Decimal              @map("quantity") @db.Decimal(12, 2)
  unitRate      Decimal              @map("unit_rate") @db.Decimal(10, 2)
  totalCost     Decimal              @map("total_cost") @db.Decimal(12, 2)
  warehouseCode String               @map("warehouse_code")
  warehouseName String               @map("warehouse_name")
  createdAt     DateTime             @map("created_at")
  createdByName String               @map("created_by_name")
  transaction   InventoryTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([warehouseCode])
  @@map("cost_ledger")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  action    String
  entity    String
  entityId  String   @map("entity_id")
  oldValue  Json?    @map("old_value")
  newValue  Json?    @map("new_value")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

enum UserRole {
  admin
  staff

  @@map("UserRole")
}

enum TenantCode {
  US
  UK

  @@map("TenantCode")
}

enum AmazonFbaFeeAlertStatus {
  UNKNOWN
  MATCH
  MISMATCH
  NO_ASIN
  MISSING_REFERENCE
  ERROR

  @@map("AmazonFbaFeeAlertStatus")
}

enum WarehouseKind {
  THIRD_PARTY
  AMAZON_FBA
  AMAZON_AWD

  @@map("WarehouseKind")
}

enum CostCategory {
  Inbound
  Storage
  Outbound
  Forwarding

  @@map("CostCategory")
}

enum TransactionType {
  RECEIVE
  SHIP
  ADJUST_IN
  ADJUST_OUT
  TRANSFER

  @@map("TransactionType")
}

enum PurchaseOrderType {
  PURCHASE
  ADJUSTMENT
  FULFILLMENT // Legacy - kept for backward compatibility

  @@map("PurchaseOrderType")
}

enum PurchaseOrderStatus {
  // New 5-stage workflow statuses
  DRAFT
  ISSUED
  MANUFACTURING
  OCEAN
  WAREHOUSE
  SHIPPED
  REJECTED
  CANCELLED
  ARCHIVED

  // Legacy statuses (for backward compatibility with existing data)
  AWAITING_PROOF
  REVIEW
  POSTED
  CLOSED

  @@map("PurchaseOrderStatus")
}

enum FulfillmentOrderStatus {
  DRAFT
  SHIPPED
  CANCELLED

  @@map("FulfillmentOrderStatus")
}

enum FulfillmentOrderLineStatus {
  PENDING
  SHIPPED
  CANCELLED

  @@map("FulfillmentOrderLineStatus")
}

enum FulfillmentDestinationType {
  CUSTOMER
  AMAZON_FBA
  TRANSFER

  @@map("FulfillmentDestinationType")
}

enum FulfillmentOrderDocumentStage {
  PACKING
  SHIPPING
  DELIVERY

  @@map("FulfillmentOrderDocumentStage")
}

enum PurchaseOrderLineStatus {
  PENDING
  POSTED
  CANCELLED

  @@map("PurchaseOrderLineStatus")
}

enum InboundReceiveType {
  CONTAINER_20
  CONTAINER_40
  CONTAINER_40_HQ
  CONTAINER_45_HQ
  LCL

  @@map("InboundReceiveType")
}

enum OutboundShipMode {
  PALLETS
  CARTONS

  @@map("OutboundShipMode")
}

enum PurchaseOrderDocumentStage {
  ISSUED
  MANUFACTURING
  OCEAN
  WAREHOUSE
  SHIPPED

  @@map("PurchaseOrderDocumentStage")
}

enum MovementNoteStatus {
  DRAFT
  POSTED
  CANCELLED
  RECONCILED

  @@map("GoodsReceiptStatus")
}

enum WarehouseInvoiceStatus {
  DRAFT
  IMPORTED
  MATCHED
  DISPUTED
  CLOSED

  @@map("WarehouseInvoiceStatus")
}
